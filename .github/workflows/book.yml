name: "book"

on:
- push


jobs:
  marimo:
    runs-on: "ubuntu-latest"

    steps:
      - uses: actions/checkout@v4

      - uses: cvxgrp/.github/actions/setup-environment-uv@main

      - name: Install marimo
        shell: bash
        run: |
          uv pip install marimo


      - name: Convert *.py files in book/marimo folder to html files
        shell: bash
        run: |
          # Create a directory for HTML outputs if it doesn't exist
          mkdir -p artifacts/marimo

          # Loop through all .py files
          for file in book/marimo/*.py; do

              echo $file

              # Skip if file is not a regular file
              [ -f "$file" ] || continue

              # Extract filename without extension
              filename=$(basename "$file" .py)
              echo $filename

              # Convert to HTML
              echo "Converting $file to HTML..."
              uv run marimo export html "$file" -o "artifacts/marimo/${filename}.html"
              uv run marimo export md "$file" -o "artifacts/marimo/${filename}.md"
          done

      - name: Archive marimo html
        uses: actions/upload-artifact@v4
        with:
          name: marimo
          path: artifacts/marimo
          retention-days: 1

  sphinx:
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - uses: cvxgrp/.github/actions/uv/sphinx@main

  test:
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - uses: cvxgrp/.github/actions/setup-environment-uv@main

      - name: Test on Linux
        shell: bash
        run: |
            uv pip install --no-cache-dir \
                          pytest \
                          pytest-cov \
                          pytest-html \
                          pytest-random-order

            uv run pytest --cov='cvx' --random-order --verbose \
                              --html=artifacts/tests/html-report/report.html \
                              --cov-report term \
                              --cov-report xml:artifacts/tests/coverage/coverage.xml \
                              --cov-report json:artifacts/tests/coverage/coverage.json \
                              --cov-report lcov:artifacts/tests/coverage/coverage.info \
                              --cov-report html:artifacts/tests/html-coverage \
                              tests/

            # I want to upload the result to gh-pages, hence this file disturbs
            rm -f artifacts/tests/html-coverage/.gitignore

      - name: Archive tests results
        uses: actions/upload-artifact@v4
        with:
          name: tests_coverage
          path: artifacts/tests
          retention-days: 1

  jupyter:
    runs-on: "ubuntu-latest"
    steps:
      - uses: actions/checkout@v4

      - uses: cvxgrp/.github/actions/uv/jupyter@main

  book:
    runs-on: "ubuntu-latest"
    needs: [test, sphinx, jupyter, marimo]

    permissions:
      contents: write

    steps:
      - uses: cvxgrp/.github/actions/book@main
