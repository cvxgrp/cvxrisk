name: Upload Python Package

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cvxgrp/.github/actions/setup-environment-uv@main

      # without dev dependencies?
      - name: Change version in pyproject.toml
        shell: bash
        run: |
           sed -i -e "s/0.0.0/${GITHUB_REF#refs/*/}/" pyproject.toml
           uv build

      - name: Archive dist folder
        uses: actions/upload-artifact@v4
        with:
           name: dist
           path: dist
           retention-days: 1

      # Push dist folder to the build branch
      - name: Publish the dist folder
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: dist     # The branch the action should deploy to.
          folder: dist     # The folder the action should deploy.

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment: release

    permissions:
      # This permission is required for trusted publishing.
      id-token: write

    steps:
      - uses: cvxgrp/.github/actions/publish@main
